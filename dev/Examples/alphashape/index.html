<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Examples · BioMakie.jl</title><meta name="title" content="Examples · BioMakie.jl"/><meta property="og:title" content="Examples · BioMakie.jl"/><meta property="twitter:title" content="Examples · BioMakie.jl"/><meta name="description" content="Documentation for BioMakie.jl."/><meta property="og:description" content="Documentation for BioMakie.jl."/><meta property="twitter:description" content="Documentation for BioMakie.jl."/><meta property="og:url" content="https://kool7d.github.io/BioMakie.jl/Examples/alphashape/"/><meta property="twitter:url" content="https://kool7d.github.io/BioMakie.jl/Examples/alphashape/"/><link rel="canonical" href="https://kool7d.github.io/BioMakie.jl/Examples/alphashape/"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.048/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.4/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">BioMakie.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs (Ctrl + /)"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../usage/">Usage</a></li><li class="is-active"><a class="tocitem" href>Examples</a><ul class="internal"><li><a class="tocitem" href="#Optional/additional-stuff"><span>Optional/additional stuff</span></a></li><li><a class="tocitem" href="#Get-the-surface-area-of-the-alpha-shape."><span>Get the surface area of the alpha shape.</span></a></li></ul></li><li><a class="tocitem" href="../../API/">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><div class="docs-left"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Examples</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Examples</a></li></ul></nav><div class="docs-right"><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Alpha-shape-of-a-protein"><a class="docs-heading-anchor" href="#Alpha-shape-of-a-protein">Alpha shape of a protein</a><a id="Alpha-shape-of-a-protein-1"></a><a class="docs-heading-anchor-permalink" href="#Alpha-shape-of-a-protein" title="Permalink"></a></h1><pre><code class="language- hljs">using BioMakie
using GLMakie
using GLMakie: Slider
using SplitApplyCombine
using GeometryBasics
using BioStructures</code></pre><p>SciPy and NumPy are required for this alpha shape algorithm. They need to be installed in your Conda/Python environment.</p><pre><code class="language- hljs">using PyCall
using Conda
scipy = pyimport_conda(&quot;scipy&quot;, &quot;scipy&quot;)
np = pyimport_conda(&quot;numpy&quot;, &quot;numpy&quot;)
collections = pyimport_conda(&quot;collections&quot;, &quot;collections&quot;)</code></pre><p>Define the alpha shape algorithm.</p><pre><code class="language- hljs">py&quot;&quot;&quot;
    from scipy.spatial import Delaunay
    import numpy as np
    from collections import defaultdict

    def alpha_shape_3D(pos, alpha):
        tetra = Delaunay(pos)
        tetrapos = np.take(pos,tetra.vertices,axis=0)
        normsq = np.sum(tetrapos**2,axis=2)[:,:,None]
        ones = np.ones((tetrapos.shape[0],tetrapos.shape[1],1))
        a = np.linalg.det(np.concatenate((tetrapos,ones),axis=2))
        Dx = np.linalg.det(np.concatenate((normsq,tetrapos[:,:,[1,2]],ones),axis=2))
        Dy = -np.linalg.det(np.concatenate((normsq,tetrapos[:,:,[0,2]],ones),axis=2))
        Dz = np.linalg.det(np.concatenate((normsq,tetrapos[:,:,[0,1]],ones),axis=2))
        c = np.linalg.det(np.concatenate((normsq,tetrapos),axis=2))
        r = np.sqrt(Dx**2+Dy**2+Dz**2-4*a*c)/(2*np.abs(a))
        tetras = tetra.vertices[r&lt;alpha,:]
        TriComb = np.array([(0, 1, 2), (0, 1, 3), (0, 2, 3), (1, 2, 3)])
        Triangles = tetras[:,TriComb].reshape(-1,3)
        Triangles = np.sort(Triangles,axis=1)
        TrianglesDict = defaultdict(int)
        for tri in Triangles:
            TrianglesDict[tuple(tri)] += 1
        Triangles=np.array([tri for tri in TrianglesDict if TrianglesDict[tri] ==1])
        EdgeComb=np.array([(0, 1), (0, 2), (1, 2)])
        Edges=Triangles[:,EdgeComb].reshape(-1,2)
        Edges=np.sort(Edges,axis=1)
        Edges=np.unique(Edges,axis=0)
        Vertices = np.unique(Edges)
        return Vertices,Edges,Triangles
    &quot;&quot;&quot;</code></pre><p>Define a function to get the alpha shape of a set of coordinates.</p><pre><code class="language- hljs">indexshift(idxs) = (idxs).+=1   # Python is base 0 and Julia is base 1
function getalphashape(coords::Matrix, alpha::T) where {T&lt;:Real}
    verts,edges,tris = py&quot;alpha_shape_3D($(coords),$(alpha))&quot;
    return [indexshift(verts),indexshift(edges),indexshift(tris)]
end</code></pre><p>Define a function to get points from spheres at a given radius around coordinates and a function to get line segments from a set of coordinates.</p><pre><code class="language-julia hljs">function getspherepoints(cords::Matrix, radius::Real)
	pnts = [GeometryBasics.Point{3,Float64}(cords[i,:]) for i in 1:size(cords,1)] |&gt; Observable
	spheres = GeometryBasics.Point{3,Float64}[]

	@sync(@async lift(pnts) do p
		for i in 1:size(p,1)
			sp = GeometryBasics.decompose(GeometryBasics.Point{3,Float64},GeometryBasics.Sphere(p[i],radius),4) |&gt; unique
			for ii in 1:size(sp,1)
				push!(spheres,sp[ii])
			end
		end
	end)

	return [[spheres[i].data...] for i in 1:size(spheres,1)] |&gt; combinedims |&gt; transpose |&gt; collect
end
function linesegs(arr::AbstractArray{T,3}) where T&lt;:AbstractFloat
    new_arr::AbstractArray{Point3f0} = []
    @sync(@async begin
        for i in 1:size(arr,1)
            push!(new_arr, Makie.Point3f0(arr[i,1,:]))
            push!(new_arr, Makie.Point3f0(arr[i,2,:]))
        end
    end)
    return new_arr |&gt; combinedims |&gt; transpose |&gt; collect
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">linesegs (generic function with 1 method)</code></pre><p>Load the structure with BioStructures.jl and get a coordinates Observable. Then set up the Figure and Layout.</p><pre><code class="language- hljs">struc = retrievepdb(&quot;2vb1&quot;)
atms = collectatoms(struc, standardselector) |&gt; Observable
cords = @lift coordarray($atms)&#39; |&gt; collect
fig = Figure(resolution = (800,600))
layout = fig[1,1] = GridLayout(10, 9)</code></pre><p>Add text and interactive elements. It can be helpful to run this line by line to see what is happening.</p><pre><code class="language- hljs">strucname = struc.name[1:4]
sc_scene = layout[1:10,1:6] = LScene(fig; show_axis = false)
structxt = layout[1,7:8] = Label(fig, text = &quot;Structure ID:  $(strucname)&quot;, fontsize = 35)
alpha1 = layout[5,7:9] = Slider(fig, range = 1.5:0.01:9.0, startvalue = 2.5)
alphatxt1 = lift(alpha1.value) do s1; string(&quot;alpha = &quot;, round(s1, sigdigits = 2)); end
alphatext = layout[4,7:9] = Label(fig, text = alphatxt1, fontsize = 22)
alphaval = alpha1.value
radii1 = layout[7,7:9] = Slider(fig, range = 1.5:0.01:9.0, startvalue = 2.5)
radiixt1 = lift(radii1.value) do s1; string(&quot;atom radius = &quot;, round(s1, sigdigits = 2)); end
radiitext = layout[6,7:9] = Label(fig, text = radiixt1, fontsize = 22)
radiival = radii1.value</code></pre><p>Get the alpha shape of the structure.</p><pre><code class="language- hljs">spnts = @lift getspherepoints($cords,$radiival)
proteinshape = @lift let pnts = $spnts; getalphashape(pnts,$alphaval); end
alphaverts = @lift $spnts[$(proteinshape)[1],:]
alphaedges = @lift $spnts[$(proteinshape)[2],:] |&gt; linesegs</code></pre><p>Finally, plot the shape. Moving the sliders will update the plot, but it is slow. You may want to click on the slider rather than dragging it. Speed may be improved in the future.</p><pre><code class="language- hljs">linesegments!(sc_scene, alphaedges, color = :gray, transparency = true)</code></pre><h2 id="Optional/additional-stuff"><a class="docs-heading-anchor" href="#Optional/additional-stuff">Optional/additional stuff</a><a id="Optional/additional-stuff-1"></a><a class="docs-heading-anchor-permalink" href="#Optional/additional-stuff" title="Permalink"></a></h2><p>#To show where the atoms are run the following line.</p><pre><code class="language- hljs">meshscatter!(sc_scene, cords, markersize = 0.4, color = :blue)</code></pre><p>#To show the alpha shape vertices run the following line.</p><pre><code class="language- hljs">meshscatter!(sc_scene, alphaverts, markersize = 0.4, color = :green)</code></pre><h2 id="Get-the-surface-area-of-the-alpha-shape."><a class="docs-heading-anchor" href="#Get-the-surface-area-of-the-alpha-shape.">Get the surface area of the alpha shape.</a><a id="Get-the-surface-area-of-the-alpha-shape.-1"></a><a class="docs-heading-anchor-permalink" href="#Get-the-surface-area-of-the-alpha-shape." title="Permalink"></a></h2><p>Define a function to get the surface area of a set of coordinates and connectivity. The surface area changes when the alpha value or atom radius is changed.</p><pre><code class="language- hljs">using Meshes
function surfacearea(coordinates, connectivity)
    totalarea = 0.0
    @sync(@async begin
        for i = 1:size(connectivity,1)
            totalarea += measure(Ngon(Meshes.Point3.(coordinates[connectivity[i,1],:],
                            coordinates[connectivity[i,2],:], coordinates[connectivity[i,3],:])))
        end
    end)
    return totalarea
end
surfarea = @lift surfacearea($spnts, $(proteinshape)[3])
surfatext = layout[2,7:9] = Label(fig, text = lift(X-&gt;string(&quot;surface area = &quot;, round(Int64, X), &quot;  Å²&quot;), surfarea), fontsize = 22)</code></pre><p>Save the figure as a png file.</p><pre><code class="language- hljs">save(&quot;alphashape.png&quot;, fig)</code></pre><p>&lt;p align=&quot;center&quot;&gt;&lt;img src=&quot;../assets/alphashape.png&quot;&gt;&lt;/p&gt;</p><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../usage/">« Usage</a><a class="docs-footer-nextpage" href="../../API/">API »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.28.0-DEV on <span class="colophon-date" title="Wednesday 3 May 2023 01:04">Wednesday 3 May 2023</span>. Using Julia version 1.8.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
